# ADR: Webhook Signature Validation

**Status:** Proposed | Approved | Superseded

## Context

*   **Risk:** `R-03` - **Подделка статуса платежа** (`L=3, I=4, Score=12`). Этот риск является высокоприоритетным из-за прямого финансового импакта (`I=4`). Успешная атака может привести к отправке товаров без фактической оплаты, что наносит прямой ущерб бизнесу.
*   **DFD:** Риск затрагивает входящий поток данных `Webhook` от `External` (Платежный шлюз) → `Service`.
*   **NFR:** `NFR-SEC-INT-001` (проверка целостности входящих данных от внешних систем).
*   **Assumptions:** Бизнес-процесс магазина критически зависит от своевременного и достоверного получения статусов платежей через вебхуки. Платежный провайдер поддерживает проверку подлинности вебхуков с помощью HMAC-подписи.

## Decision

Мы принимаем решение о **внедрении обязательной проверки криптографической подписи для всех входящих вебхуков от платежного провайдера**. Это гарантирует, что мы обрабатываем только подлинные и неискаженные сообщения.

*   **Политика 1: Проверка HMAC-подписи**
    *   **Что:** Для каждого входящего запроса на эндпоинт `/api/webhooks/payment-status` будет вычисляться подпись HMAC-SHA256 на основе полного тела запроса и секретного ключа. Вычисленная подпись будет сравниваться с подписью, переданной провайдером в заголовке (например, `X-Payment-Signature`).
    *   **Слой:** Приложение (Application Layer, Middleware/Decorator).
    *   **Метод:** Реализация middleware, который применяется непосредственно к эндпоинту вебхука.

*   **Политика 2: Обработка невалидных запросов**
    *   **Что:** Если подписи не совпадают, запрос должен быть немедленно отклонен со статусом `400 Bad Request`.
    *   **Слой:** Приложение (Middleware).
    *   **Метод:** Отклонение запроса до начала любой бизнес-логики. Инцидент должен быть залогирован с высоким уровнем приоритета для дальнейшего анализа.

*   **Политика 3: Управление секретным ключом**
    *   **Что:** Секретный ключ, используемый для проверки подписи, должен управляться как высокоприоритетный секрет.
    *   **Слой:** Инфраструктура (Secrets Management).
    *   **Метод:** Хранение ключа в защищенном хранилище (например, HashiCorp Vault, AWS Secrets Manager) и его загрузка в приложение во время выполнения. Ключ не должен находиться в исходном коде или файлах конфигурации.

## Alternatives

*   **Альтернатива B: Фильтрация по IP-адресам.**
    *   *Причина отклонения:* Ненадежно. IP-адреса могут меняться без предупреждения, а также могут быть подделаны. Этот метод не защищает от изменения данных в пути (tampering).
*   **Альтернатива C: Опрос API (Polling).**
    *   *Причина отклонения:* Является избыточно сложным и дорогостоящим решением. Polling создает ненужную нагрузку на API провайдера, вносит задержку в обработку платежей и требует реализации фонового процесса для управления состоянием.

## Consequences

**Положительные:**
*   Обеспечивает криптографическую гарантию того, что вебхук был отправлен именно платежным провайдером (аутентичность) и не был изменен в пути (целостность).
*   Эффективно предотвращает мошеннические операции, связанные с подделкой статуса платежа.
*   Соответствует лучшим практикам безопасности, рекомендуемым большинством платежных систем.

**Негативные/издержки:**
*   Появляется новый критически важный секрет, который требует безопасного хранения и ротации.
*   Неправильная конфигурация секрета или ошибка в логике проверки подписи может привести к отклонению легитимных вебхуков, что нарушит процесс обработки заказов.

## DoD / Acceptance (Definition of Done)

**Given** входящий запрос на эндпоинт `/api/webhooks/payment-status` с невалидной подписью в заголовке `X-Payment-Signature`
**When** система получает этот запрос
**Then** система должна вернуть ответ со статусом `400 Bad Request` и не должна изменять статус соответствующего заказа.

**Checks:**
*   **test:** Интеграционные тесты `test_webhook_rejects_invalid_signature` и `test_webhook_accepts_valid_signature`.
*   **log:** В логах появляется запись с уровнем `WARN` вида: `Invalid webhook signature received from IP <source_ip>. Request rejected.`.
*   **scan/policy:** Secret-сканер в CI/CD пайплайне проверяет, что секретный ключ для подписи вебхуков не закоммичен в репозиторий.
*   **metric/SLO:** Настроен алерт, который срабатывает, если количество отклоненных вебхуков превышает 1% от общего числа за последние 10 минут.

## Rollback / Fallback

*   Проверка подписи будет управляться через **Feature Flag**. В случае массовых сбоев ее можно будет временно отключить для анализа проблемы, при этом алерт на аномальное количество вебхуков останется активным.
*   Обязательное логирование IP-адреса, с которого пришел невалидный вебхук, для быстрой диагностики.

## Trace

*   **DFD:** Входящий поток `Webhook` от `External` → `Service`
*   **STRIDE:** Строки, касающиеся Spoofing (S) и Tampering (T) для внешних потоков.
*   **Risk scoring:** `R-03`, **Top-3**
*   **NFR:** `NFR-SEC-INT-001`
*   **Issues:** `#issue-webhook-validation`

## Ownership & Dates

*   **Owner:** VDK
*   **Date created:** 09.11.2025
*   **Last updated:** 09.11.2025

## Open Questions

*   Какова политика платежного провайдера по ротации секретных ключей?
*   Поддерживает ли провайдер несколько активных ключей одновременно для обеспечения плавной ротации?