# ADR: PII Encryption & Masking Strategy

**Status:** Proposed | Approved | Superseded

## Context

*   **Risk:** `R-01` - **Массовая утечка PII** (`L=4, I=5, Score=20`). Этот риск является главным приоритетом, так как его реализация ведет к максимальному ущербу: потере репутации, крупным штрафам (GDPR) и судебным искам.
*   **DFD:** Риск затрагивает несколько элементов: `API Gateway` (логи), `Store Service` (обработка и логирование) и `DB` (хранение).
*   **NFR:** `NFR-SEC-PII-001` (маскирование ПДн), `NFR-SEC-CONF-001` (хранение паролей, применимо и к другим ПДн).
*   **Assumptions:** Система обрабатывает чувствительные персональные данные (имена, адреса), что подпадает под регуляторные требования. Стек разработки позволяет использовать стандартные криптографические библиотеки.

## Decision

Мы принимаем комплексное решение для защиты PII на разных уровнях, чтобы обеспечить глубоко эшелонированную защиту. Стратегия включает шифрование данных при хранении (at-rest) и маскирование при обработке (в логах и API-ответах).

*   **Политика 1: Шифрование в БД (At-Rest)**
    *   **Что:** Все поля, содержащие PII (например, `users.full_name`, `users.phone`, `orders.shipping_address`), должны быть зашифрованы на уровне колонок в базе данных.
    *   **Слой:** База данных (PostgreSQL).
    *   **Метод:** Использование расширения `pgcrypto` или аналогичной проверенной библиотеки для колоночного шифрования.

*   **Политика 2: Маскирование в логах**
    *   **Что:** PII не должны попадать в логи в открытом виде. Значения должны заменяться на маску (например, `email: "u***@e***.com"`).
    *   **Слой:** Приложение (Application Layer).
    *   **Метод:** Внедрение централизованного логгер-middleware, который фильтрует и маскирует чувствительные поля перед записью лога.

*   **Политика 3: Маскирование в API-ответах**
    *   **Что:** API-эндпоинты не должны возвращать PII, если это не является абсолютно необходимым для функции.
    *   **Слой:** Приложение (API DTOs / Serializers).
    *   **Метод:** По умолчанию все PII-поля в DTO исключаются из сериализации. Для их включения требуется явное указание (например, в специальных "детальных" эндпоинтах с повышенными правами доступа).

## Alternatives

*   **Альтернатива B: Только маскирование.**
    *   *Причина отклонения:* Дешево и быстро, но не защищает от основного вектора атаки — прямой утечки данных из БД (например, через SQL-инъекцию или украденный бэкап). `Security Impact` недостаточен для риска с `Impact=5`.
*   **Альтернатива C: Токенизация через внешний сервис.**
    *   *Причина отклонения:* Обеспечивает максимальную безопасность, но является избыточно сложным, дорогим и вносит сильную зависимость от внешнего Vault-сервиса, что не оправдано на текущем этапе.

## Consequences

**Положительные:**
*   Значительно снижается риск компрометации персональных данных даже в случае полной утечки базы данных.
*   Обеспечивается соответствие регуляторным требованиям (GDPR).
*   Снижается риск случайного раскрытия PII разработчиками через логи или API.

**Негативные/издержки:**
*   Небольшое увеличение задержки (latency) из-за операций шифрования/дешифрования.
*   Усложнение отладки, так как в логах данные будут маскированы.
*   Усложнение прямых запросов к БД (например, поиск по зашифрованному полю).

## DoD / Acceptance (Definition of Done)

**Given** запрос на создание пользователя с PII (имя, адрес)
**When** запрос успешно обработан и данные сохранены
**Then** при прямом просмотре таблицы `users` в БД поля `full_name` и `shipping_address` содержат зашифрованные строки, а в логах приложения эти данные маскированы.

**Checks:**
*   **test:** Интеграционный тест `e2e-pii-handling` проверяет, что API не возвращает PII, а лог содержит маскированные данные. Модульный тест проверяет, что сервис корректно шифрует данные перед сохранением.
*   **log:** В логах приложения присутствует запись `User created with redacted PII`, где все чувствительные поля заменены на `***`.
*   **scan/policy:** В статический анализатор добавлен кастомный паттерн, который ищет PII-поля в логах.
*   **metric/SLO:** Увеличение P95 latency для запросов, работающих с PII, не должно превышать 15%.

## Rollback / Fallback

*   Маскирование в логах и API будет управляться через **Feature Flag**. В случае проблем его можно будет отключить в реальном времени.
*   Шифрование данных в БД является миграцией с необратимыми последствиями. Откат возможен только путем восстановления из бэкапа, сделанного до миграции.

## Trace

*   **DFD:** `API Gateway`, `Store Service`, `DB (PostgreSQL)`
*   **STRIDE:** Строки, касающиеся Information Disclosure (I) для узлов `Store Service`, `DB` и потоков между ними.
*   **Risk scoring:** `R-01`, **Top-1**
*   **NFR:** `NFR-SEC-PII-001`, `NFR-SEC-CONF-001`
*   **Issues:** `#issue-pii-encryption`, `#issue-pii-masking`

## Ownership & Dates

*   **Owner:** VDK
*   **Date created:** 09.11.2025
*   **Last updated:** 09.11.2025

## Open Questions

*   Какой именно алгоритм шифрования и библиотеку для PostgreSQL выбрать?
*   Составить исчерпывающий список всех PII-полей в системе.
*   Провести нагрузочное тестирование для оценки влияния шифрования на производительность.