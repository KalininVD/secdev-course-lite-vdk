## 0) Контекст риска (из S04)

*   **Risk-ID:** `R-01`    **Threat:** `I (Information Disclosure)`
*   **DFD element/edge:** `API Gateway`, `Store Service`, `DB (PostgreSQL)`
*   **NFR link (ID):** `NFR-SEC-PII-001`, `NFR-SEC-CONF-001`
*   **L×I (1-5):** `L=4, I=5, Score=20`
*   **Ограничения/предпосылки:** Система обрабатывает персональные данные клиентов (имена, адреса), что подпадает под регуляторные требования (например, GDPR). Стек предполагает использование стандартных библиотек для шифрования.

## 1) Критерии и шкалы (1-5)

**Польза (чем больше - тем лучше, ↑):**

* **Security impact (↑):** насколько альтернатива снижает риск (предотвращает/обнаруживает/сдерживает).
* **Blast radius reduction (↑):** насколько сужает возможный ущерб (только один тенант/аккаунт/фича вместо всего сервиса).

**Стоимость/сложность (чем меньше - тем лучше, ↓):**

* **Complexity (↓):** сложность внедрения (код/конфиг/политики).
* **Time-to-mitigate (↓):** сколько времени до эффекта (в днях/спринтах).
* **Dependencies (↓):** внешние/внутренние зависимости (команды, провайдеры, миграции).

> Оценка **1-5**: 1 - минимально / 5 - максимально. Для «стоимостных» критериев **меньше - лучше**.

**Итоговые метрики (подсказка):**

* **Benefit = Security impact + Blast radius reduction**
* **Cost = Complexity + Time-to-mitigate + Dependencies**
* **Net = Benefit − Cost**  *(чем больше, тем привлекательнее)*

## 2) Таблица сравнения вариантов

| Alternative | Summary (1-2 фразы)                                                                           | Security impact (↑,1-5) | Blast radius reduction (↑,1-5) | Complexity (↓,1-5) | Time-to-mitigate (↓,1-5) | Dependencies (↓,1-5) | **Benefit** | **Cost** | **Net** | Notes                                                                                          |
|:------------|:----------------------------------------------------------------------------------------------|:------------------------|:-------------------------------|:-------------------|:-------------------------|:---------------------|:------------|:---------|:--------|:-----------------------------------------------------------------------------------------------|
| **A**       | **Комплексный подход:** Шифрование PII в БД (at-rest) + маскирование в логах и API.           | 4                       | 4                              | 3                  | 3                        | 2                    | **8**       | **8**    | **0**   | "Золотая середина". Защищает и от утечки БД, и от случайного раскрытия.                        |
| **B**       | **Только маскирование:** PII не шифруются в БД, но маскируются в логах и API-ответах.         | 2                       | 2                              | 1                  | 1                        | 1                    | **4**       | **3**    | **+1**  | Дешево и быстро, но не защищает от главного риска — прямой утечки из базы данных.              |
| **C**       | **Токенизация:** PII не хранятся в системе, а заменяются на токены из внешнего Vault-сервиса. | 5                       | 5                              | 5                  | 5                        | 5                    | **10**      | **15**   | **-5**  | Максимальная безопасность, но крайне сложно, дорого и создает зависимость от внешнего сервиса. |

## 3) Тай-брейкеры при равенстве Net

*   В данном случае явного равенства нет, но можно отметить, что у варианта **B** `Net` выше, однако его **Security Impact** (2) недостаточен для покрытия риска с `Impact=5`. Поэтому мы выбираем вариант **A**, который обеспечивает необходимый уровень защиты.

## 4) Решение (для переноса в ADR)

*   **Chosen alternative:** **A**
*   **Почему:** Этот вариант обеспечивает наилучший баланс между уровнем защиты и сложностью реализации. Он комплексно закрывает риск утечки PII как на уровне хранения (шифрование в БД), так и на уровне обработки (маскирование в логах/API). Альтернатива B слишком слабая, а альтернатива C — избыточно сложная и дорогая для текущего контекста.
*   **ADR candidate (название):** `PII Encryption & Masking Strategy`
*   **Связки:** Risk-ID `R-01`, NFR-ID `NFR-SEC-PII-001, NFR-SEC-CONF-001`, DFD `API Gateway, Store Service, DB`
*   **Следующие шаги (минимум):**
    1.  Выбрать библиотеку для колоночного шифрования в PostgreSQL.
    2.  Определить точный список полей, подлежащих шифрованию.
    3.  Реализовать middleware для маскирования PII в логах.
    4.  Адаптировать DTO для API, чтобы чувствительные поля не отдавались наружу по умолчанию.