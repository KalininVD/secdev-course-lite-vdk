# ADR: Centralized AuthZ Middleware

**Status:** Proposed | Approved | Superseded

## Context

*   **Risk:** `R-02` - **Обход авторизации (IDOR)** (`L=5, I=3, Score=15`). Этот риск является вторым по приоритету из-за его чрезвычайно высокой вероятности (`L=5`), так как это одна из самых распространенных уязвимостей в веб-приложениях (OWASP Top 10), которую легко эксплуатировать.
*   **DFD:** Риск возникает в потоке обработки запроса: `API Gateway` → `Store Service` → `DB`.
*   **NFR:** `NFR-SEC-AUTHZ-001` (изоляция данных пользователей).
*   **Assumptions:** Система является многопользовательской, где у сущностей (заказы, профили) есть четкий "владелец". Архитектура использует единую точку входа для API-запросов, что делает возможным централизованное решение.

## Decision

Мы принимаем решение о внедрении **централизованного middleware-компонента для проверки авторизации** на уровне веб-фреймворка. Этот компонент будет перехватывать все входящие запросы к защищаемым ресурсам и проверять права доступа до того, как запрос достигнет основной бизнес-логики.

*   **Политика 1: Логика проверки владения**
    *   **Что:** Middleware будет автоматически извлекать `userId` из JWT-токена и `resourceId` из URL-параметра (например, `/api/orders/{orderId}`). Затем он выполнит запрос к базе данных, чтобы убедиться, что запрашиваемый ресурс принадлежит этому пользователю.
    *   **Слой:** Приложение (Application Layer, Middleware).
    *   **Метод:** Реализация декоратора или middleware, который можно декларативно применять к группам эндпоинтов.

*   **Политика 2: Обработка отказа в доступе**
    *   **Что:** В случае, если проверка владения не пройдена, middleware немедленно прерывает выполнение запроса и возвращает ответ с кодом `404 Not Found`.
    *   **Слой:** Приложение (Middleware).
    *   **Метод:** Возврат `404` вместо `403 Forbidden` является лучшей практикой, так как это не раскрывает злоумышленнику сам факт существования чужого ресурса.

*   **Политика 3: Область применения**
    *   **Что:** Данный middleware будет принудительно применяться ко всем эндпоинтам, которые работают с ресурсами, принадлежащими конкретному пользователю.
    *   **Слой:** Конфигурация маршрутизации (Routing).
    *   **Метод:** Применение middleware к группам маршрутов, например `/api/orders/*`, `/api/profile/*`, `/api/addresses/*`.

## Alternatives

*   **Альтернатива B: Проверки "вручную" в каждом обработчике.**
    *   *Причина отклонения:* Такой подход крайне подвержен человеческой ошибке. Легко забыть добавить проверку в новый эндпоинт, что немедленно создаст уязвимость. `Security Impact` слишком низкий.
*   **Альтернатива C: Внешний Policy Engine (OPA/Casbin).**
    *   *Причина отклонения:* Является избыточно сложным решением для текущей задачи проверки простого "владения" ресурсом. Внедрение OPA требует изучения нового языка (Rego) и развертывания дополнительной инфраструктуры.

## Consequences

**Положительные:**
*   Системно устраняет весь класс уязвимостей IDOR.
*   Обеспечивает консистентное применение политик авторизации ко всем новым эндпоинтам.
*   Упрощает код бизнес-логики, так как из него уходит дублирующийся код проверок прав доступа.

**Негативные/издержки:**
*   Добавляет один дополнительный запрос к БД на каждый проверяемый API-вызов, что может незначительно увеличить задержку.
*   Middleware становится единой точкой отказа для авторизации: ошибка в нем затронет все защищенные эндпоинты.

## DoD / Acceptance (Definition of Done)

**Given** аутентифицированный пользователь `user-A` и существующий заказ `{orderId_B}`, принадлежащий пользователю `user-B`
**When** `user-A` отправляет запрос `GET /api/orders/{orderId_B}`
**Then** система должна вернуть ответ со статусом `404 Not Found` и залогировать попытку несанкционированного доступа.

**Checks:**
*   **test:** Интеграционный тест `test_user_cannot_access_another_users_order` в CI/CD пайплайне.
*   **log:** В логах появляется запись с уровнем `WARN` вида: `Authorization failed: user 'user-A' attempted to access resource 'order:{orderId_B}' owned by 'user-B'`.
*   **scan/policy:** В чеклист для Code Review добавлен пункт: "Для нового эндпоинта, работающего с данными пользователя, применен `AuthZ Middleware`?".
*   **metric/SLO:** Добавлен мониторинг latency для `AuthZ Middleware`, P99 не должен превышать 20ms.

## Rollback / Fallback

*   Применение middleware к маршрутам будет управляться централизованно в коде конфигурации роутера. В случае серьезных проблем его можно будет закомментировать и быстро выкатить исправление.
*   Будет настроен алерт на аномальный всплеск `404` ошибок в логах, что может сигнализировать о проблеме в работе middleware.

## Trace

*   **DFD:** Поток `API Gateway` → `Store Service` → `DB`
*   **STRIDE:** Строки, касающиеся Elevation of Privilege (E), Information Disclosure (I), Tampering (T).
*   **Risk scoring:** `R-02`, **Top-2**
*   **NFR:** `NFR-SEC-AUTHZ-001`
*   **Issues:** `#issue-authz-middleware`

## Ownership & Dates

*   **Owner:** VDK
*   **Date created:** 09.11.2025
*   **Last updated:** 09.11.2025

## Open Questions

*   Как middleware будет обрабатывать более сложные сценарии (например, администратор, который имеет доступ ко всем заказам)?
*   Нужна ли оптимизация (например, кэширование прав), если один клиент делает много запросов подряд?