# DV - Мини-проект «DevOps-конвейер»

## 0) Мета

- **Проект (опционально BYO):** Учебный шаблон `secdev-seed-s06-s08` (веб-приложение на FastAPI).
- **Версия (commit/date):** 09.11.2025
- **Кратко (1-2 предложения):** Обеспечение воспроизводимости локальной сборки, исправление уязвимостей (SQLi, XSS, валидация ввода) и запуск 6 автотестов для учебного проекта.

## 1) Воспроизводимость локальной сборки и тестов (DV1)

- **Одна команда для сборки/тестов:**

  ```bash
  # ОС: Windows 11 / PowerShell 5.1.26100.7019
  # Python: 3.12.3
  make ci-s06
  ```

- **Версии инструментов (фиксация):**

  _Версии зависимостей Python зафиксированы в `requirements.txt`. Для 100% воспроизводимости точные версии окружения сохранены в артефакте [`pip-freeze.txt`](../EVIDENCE/S06/pip-freeze.txt)._

- **Описание шагов (кратко):**

  1. Склонировать репозиторий с кодом ([`secdev-course-lite-vdk-dv`](https://github.com/KalininVD/secdev-course-lite-vdk-dv)).
  2. (При необходимости) Создать файл `.env` на основе шаблона `.env.example`.
  3. Выполнить в терминале команду `make ci-s06`.
  4. Проверить отчет о прогоне тестов в `EVIDENCE/S06/test-report.xml`.

## 2) Безопасность кода (Secure Coding - S06)

_Этот раздел добавлен для явной фиксации исправлений, которые являются частью критерия DV3._

- **Карточка S06-01: SQL Injection (login)**
  - **Было:** SQL-запрос для аутентификации формировался с помощью f-строки.
  - **Стало:** Запрос заменен на параметризованный, данные передаются отдельно.
  - **Тест:** `tests/test_login_sql_injection.py` успешно проходит.

- **Карточка S06-02: SQL Injection (search LIKE)**
  - **Было:** SQL-запрос для поиска формировался с помощью f-строки.
  - **Стало:** Запрос заменен на параметризованный.
  - **Тест:** `tests/test_search_sql_like.py` успешно проходит.

- **Карточка S06-03: XSS (экранирование вывода)**
  - **Было:** В HTML-шаблоне использовался небезопасный фильтр `|safe`.
  - **Стало:** Фильтр `|safe` убран, используется автоэкранирование Jinja2.
  - **Тест:** `tests/test_xss_escaping.py` успешно проходит.
 
- **Карточка S06-04: Валидация ввода**
  - **Было:** Модели Pydantic не имели строгих ограничений на формат и длину данных.
  - **Стало:** Добавлены `constr` с регулярными выражениями и ограничениями по длине, что позволило блокировать SQLi-атаки еще на уровне валидации (возвращая код 422).
  - **Тест:** `tests/test_login_sql_injection.py` был адаптирован для проверки кода 422.

## 3) Контейнеризация (DV2)

- **Dockerfile:** TODO: `path/to/Dockerfile` (база, multi-stage? минимальный образ?)
- **Сборка/запуск локально:**

  ```bash
  docker build -t app:local .
  docker run --rm -p 8080:8080 app:local
  ```

  _Укажите порт/команду/healthcheck, если есть._

- **(Опционально) docker-compose:** `TODO: path/to/docker-compose.yml` - кратко, какие сервисы.

## 4) CI: базовый pipeline и стабильный прогон (DV3)

- **Платформа CI:** TODO: GitHub Actions / GitLab CI / другое
- **Файл конфига CI:** TODO: путь (напр., `.github/workflows/ci.yml`)
- **Стадии (минимум):** checkout → deps → **build** → **test** → (package)
- **Фрагмент конфигурации (ключевые шаги):**

  ```yaml
  # TODO: укоротите под себя
  jobs:
  build_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - name: Cache deps
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ hashFiles('**/requirements*.txt') }}
      - run: pip install -r requirements.txt
      - run: pytest -q

  ```

- **Стабильность:** TODO: последние N запусков зелёные? краткий комментарий
- **Ссылка/копия лога прогона:** `EVIDENCE/ci-YYYY-MM-DD-build.txt`

## 5) Артефакты и логи конвейера (DV4)

| Артефакт/лог             | Путь в `EVIDENCE/`      | Комментарий                                                        |
| ------------------------ | ----------------------- | ------------------------------------------------------------------ |
| Отчет о тестах           | `S06/test-report.xml`   | JUnit XML отчет, подтверждающий успешное прохождение 6/6 тестов.   |
| Лог локального запуска   | `S06/local-run-log.txt` | Полный текстовый лог выполнения команды `make ci-s06`.             |
| Замороженные зависимости | `S06/pip-freeze.txt`    | Список точных версий всех зависимостей для 100% воспроизводимости. |

## 6) Секреты и переменные окружения (DV5 - гигиена, без сканеров)

- **Шаблон окружения:** добавлен файл `/.env.example` со списком переменных (без значений), например:
  - `REG_USER=`
  - `REG_PASS=`
  - `API_TOKEN=`
- **Хранение и передача в CI:**  
  - секреты лежат в настройках репозитория/организации (**masked**),  
  - в pipeline они **не печатаются** в явном виде.
- **Пример использования секрета в job (адаптируйте):**

  ```yaml
  - name: Login to registry (masked)
    env:
      REG_USER: ${{ secrets.REG_USER }}
      REG_PASS: ${{ secrets.REG_PASS }}
    run: |
      echo "::add-mask::$REG_PASS"
      echo "$REG_PASS" | docker login -u "$REG_USER" --password-stdin registry.example.com
  ```

- **Быстрая проверка отсутствия секретов в коде (любой простой способ):**

  ```bash
  # пример: поиск популярных паттернов
  git grep -nE 'AKIA|SECRET|token=|password=' || true
  ```

  _Сохраните вывод в `EVIDENCE/grep-secrets.txt`._
- **Памятка по ротации:** TODO: кто/как меняет secrets при утечке/ревоке токена.

## 7) Индекс артефактов DV

| Тип     | Файл в `EVIDENCE/`            | Дата/время         | Коммит/версия | Runner/OS    |
|---------|--------------------------------|--------------------|---------------|--------------|
| CI-лог  | `ci-YYYY-MM-DD-build.txt`      | `YYYY-MM-DD hh:mm` | `abc123`      | `gha-ubuntu` |
| Лок.лог | `local-build-YYYY-MM-DD.txt`   | …                  | `abc123`      | `local`      |
| Package | `package-notes.txt`            | …                  | `abc123`      | -            |
| Freeze  | `pip-freeze.txt` (или аналог)  | …                  | `abc123`      | -            |
| Grep    | `grep-secrets.txt`             | …                  | `abc123`      | -            |

## 8) Связь с TM и DS (hook)

- **TM:** этот конвейер обслуживает риски процесса сборки/поставки (например, культура работы с секретами, воспроизводимость).  
- **DS:** сканы/гейты/триаж будут оформлены в `DS.md` с артефактами в `EVIDENCE/`.

## 9) Самооценка по рубрике DV (0/1/2)

- **DV1. Воспроизводимость локальной сборки и тестов:** 2
- **DV2. Контейнеризация (Docker/Compose):** 0
- **DV3. CI: базовый pipeline и стабильный прогон:** 0
- **DV4. Артефакты и логи конвейера:** 1
- **DV5. Секреты и конфигурация окружения (гигиена):** 1

**Итог DV (сумма):** 5/10 (на данном этапе)